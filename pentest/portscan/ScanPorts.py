#-------------------------------------------------------------
 # 
 #   .SYNOPSIS
 #   ScanPorts - a simple, Scapy-based port scanning tool
 #   
 #   .NOTES
 #   Author: Charles Christensen
 #   Required Dependencies: python3, scapy, python-magic
 #   
#-------------------------------------------------------------

#==========================================
#  PARMETERS / VARIABLES
#==========================================

# Import libraries.
import scapy.all as scapy   # scapy
import netaddr              # netaddr
import magic                # python-magic, python-magic-bin
import sys                  # n/a
import os                   # n/a

# Define variables.
KNOWN_PORTS = [21,22,23,25,53,80,110,111,135,139,143,443,445,993,995,1723,3306,3389,5900,8080]
HELP_MSG = '''
SYNOPSIS
    ScanPorts - a simple, Scapy-based port scanning tool
                authored by Charles Christensen

USAGE
    python3 ScanPorts.py [OPTIONS]

OPTIONS
    -h, --help, -?
        Display this help message
'''
hosts = set()
ports = set(KNOWN_PORTS)
types = set(["tcp","udp"])
delay = 2
source = "RAND"

#==========================================
#  FUNCTIONS
#==========================================

# Print out colorful CLI messages.
def CustomPrint(message, color="WHITE", newline=True):
    
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    ENDC = '\033[0m'
    
    if color == "GREEN":
        print(GREEN, end='')
    if color == "YELLOW":
        print(YELLOW, end='')
    if color == "RED":
        print(RED, end='')
    if color == "WHITE":
        print(ENDC, end='')
    
    print(message, end='')
    
    if newline:
        print(ENDC)
    else:
        print(ENDC, end='')

# Check if string is valid IP.
def IsIP(text):
    try:
        netaddr.IPAddress(text)
    except:
        return False
    return True

# Ping an IP address.
def PingHost(host,_timeout):
    pkt = scapy.IP(dst=host)/scapy.ICMP()
    rply = scapy.sr1(pkt, timeout=_timeout)
    CustomPrint("    PING is ", "WHITE", False)
    if str(type(rply)) == "<type 'NoneType'>":
        CustomPrint("unsuccessful", "RED")
    else:
        CustomPrint("successful", "GREEN")

# Check if TCP port is open.
# Source <https://resources.infosecinstitute.com/port-scanning-using-scapy/>
def ScanTcpPort(dst_host,dst_port,src_port,_timeout):
    pkt = scapy.IP(dst=dst_host)/scapy.TCP(sport=src_port,dport=dst_port,flags="S")
    rply = scapy.sr1(pkt, timeout=_timeout)
    CustomPrint("    " + str(dst_port) + "/TCP is ", "WHITE", False)
    if str(type(rply)) == "<type 'NoneType'>":
        CustomPrint("filtered", "YELLOW")
    elif rply.getlayer(TCP).flags == 0x12:
        pkt = scapy.IP(dst=dst_host)/scapy.TCP(sport=src_port,dport=dst_port,flags="R")
        rply = scapy.sr1(pkt, timeout=_timeout)
        CustomPrint("open", "GREEN")
    elif rply.getlayer(TCP).flags == 0x14:
        CustomPrint("closed", "RED")
    elif (str(rply.getlayer(ICMP).type) == 3) and (int(rply.getlayer(ICMP).code) in [1,2,3,9,10,13]):
        CustomPrint("filtered", "YELLOW")

# Check if UDP port is open.
# Source <https://resources.infosecinstitute.com/port-scanning-using-scapy/>
def ScanUdpPort(dst_host,dst_port,src_port,_timeout):
    pkt = scapy.IP(dst=dst_host)/scapy.TCP(sport=src_port,dport=dst_port,flags="S")
    rply = scapy.sr1(pkt, timeout=_timeout)
    CustomPrint("    " + str(dst_port) + "/UDP is ", "WHITE", False)
    if str(type(rply)) == "<type 'NoneType'>":
        CustomPrint("filtered", "YELLOW")
    elif rply.getlayer(TCP).flags == 0x12:
        pkt = scapy.IP(dst=dst_host)/scapy.TCP(sport=src_port,dport=dst_port,flags="R")
        rply = scapy.sr1(pkt, timeout=_timeout)
        CustomPrint("open", "GREEN")
    elif rply.getlayer(TCP).flags == 0x14:
        CustomPrint("closed", "RED")
    elif (str(rply.getlayer(ICMP).type) == 3) and (int(rply.getlayer(ICMP).code) in [1,2,3,9,10,13]):
        CustomPrint("filtered", "YELLOW")

def GenerateSourcePort(source, port):
    if type(source) == "<class 'int'>":
        return int(source)
    if source == "MIRROR":
        return int(port)
    if source == "RAND":
        return int(scapy.RandShort())

#==========================================
#  MAIN
#==========================================

# Check CLI parameters.
params = sys.argv.copy()
params[0] = ""
if len(params) < 3:
    CustomPrint("ERROR! Target host not specified. (Use '--help' for more information.)", "RED")
    sys.exit()

# Parse CLI parameters.
index = 0
for param in params:
    param = param.lower()
    
    # Help flag.
    if (param == "--help") or ("?" in param):
        CustomPrint(HELP_MSG, "GREEN")
        sys.exit()
    
    # Target host flag.
    if (param == "-h") or (param == "--host") or (param == "--hosts"):
        
        # Extract IP addresses from text file.
        if os.path.isfile(params[index+1]):
            filepath = params[index+1]
            filetype = magic.Magic(mime=True)
            if filetype.from_file(filepath) != "text/plain":
                CustomPrint("ERROR! Invalid hosts file. Must be a multi-line text file. <" + params[index+1] + ">", "RED")
                sys.exit()
            try:
                filestream = open(filepath, "r")
                line = filestream.readline().strip()
                while line:
                    if IsIP(line):
                        hosts.add(line)
                    else:
                        CustomPrint("WARNING! Excluding invalid IP address from scan. <" + line + ">", "YELLOW")
                    line = filestream.readline().strip()
            except:
                CustomPrint("ERROR! Unable to open hosts file.", "RED")
                sys.exit()
            finally:
                filestream.close()
        
        # Extract IP addresses from CIDR range.
        elif "/" in params[index+1]:
            try:
                netaddr.IPNetwork(params[index+1])
            except:
                CustomPrint("ERROR! Invalid CIDR range. <" + params[index+1] + ">", "RED")
                sys.exit()
            for ip in netaddr.IPNetwork(params[index+1]):
                hosts.add(str(ip))
        
        # Add a single IP address.
        else:
            if IsIP(params[index+1]):
                hosts.add(params[index+1])
            else:
                CustomPrint("ERROR! Invalid IP address. <" + params[index+1] + ">", "RED")
                sys.exit()
        
        if len(hosts) > 0:
            params[index] = ""
            params[index+1] = ""
    
    # Target ports flag.
    if (param == "-p") or (param == "--port") or (param == "--ports"):
        raw_ports = params[index+1].lower().split(",")
        for raw_port in raw_ports:
            if "-" in raw_port:
                raw_port_range = raw_port.split("-")
                for num in range(int(raw_port_range[0]), int(raw_port_range[1])+1):
                    ports.add(int(num))
            elif raw_port == "all":
                for num in range(0, 65536):
                    ports.add(int(num))
            elif (raw_port == "reserved") or (raw_port == "privileged"):
                for num in range(0, 1024):
                    ports.add(int(num))
            elif (raw_port == "known") or (raw_port == "top"):
                for known_port in KNOWN_PORTS:
                    ports.add(int(known_port))
            else:
                ports.add(int(raw_port))
        
        if len(ports) > 0:
            params[index] = ""
            params[index+1] = ""
    
    # Port scan type flag.
    if (param == "-t") or (param == "--type") or (param == "--types"):
        types = set()
        raw_types = params[index+1].lower().split(",")
        for raw_type in raw_types:
            if (raw_type == "tcp") or (raw_type == "udp") or (raw_type == "icmp"):
                types.add(raw_type)
            elif raw_type == "ping":
                types.add("icmp")
            else:
                CustomPrint("WARNING! Excluding invalid port scan type. <" + raw_type + ">.", "YELLOW")
        
        if len(types) > 0:
            params[index] = ""
            params[index+1] = ""
    
    # Delay/timeout flag.
    if (param == "-d") or (param == "--delay"):
        delay = int(params[index+1])
        params[index] = ""
        params[index+1] = ""
    
    # Source port flag.
    if (param == "-s") or (param == "--source"):
        try:
            source = int(params[index+1])
        except:
            if (params[index+1].lower() == "rand") or (params[index+1].lower() == "rnd") or (params[index+1].lower() == "random"):
                source = "RAND"
            elif (params[index+1].lower() == "mirror"):
                source = "MIRROR"
            else:
                CustomPrint("ERROR! Invalid source port specified. <" + params[index+1] + ">.", "RED")
                sys.exit()
    
    index = index + 1

# Verify CLI parameters.
for param in params:
    if param != "":
        CustomPrint("ERROR! Invalid parameter. <" + param + ">", "RED")
        sys.exit()
if len(hosts) < 1:
    CustomPrint("ERROR! No valid IP hosts specified.", "RED")
    sys.exit()
if len(ports) < 1:
    CustomPrint("ERROR! No valid ports specified.", "RED")
    sys.exit()
if len(types) < 1:
    CustomPrint("ERROR! No valid port scan types specified.", "RED")
    sys.exit()

# Perform stealth scanning.
CustomPrint("")
for host in hosts:
    CustomPrint("Scanning host " + host + "...")
    if "icmp" in types:
        PingHost(host, delay)
    for port in ports:
        if "tcp" in types:
            src = GenerateSourcePort(source, port)
            ScanTcpPort(host, port, src, delay)
        if "udp" in types:
            src = GenerateSourcePort(source, port)
            ScanUdpPort(host, port, src, delay)
    CustomPrint("")
